<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Login Page -->
    <template id="login" inherit_id="web.login" name="Login with reCAPTCHA">
        <xpath expr="//form" position="after">
            <script src="https://www.google.com/recaptcha/api.js?render=6LdhdR4rAAAAAE8GMt_ToOGXsfqvUe2Mv4lXRpUX"></script>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const loginForm = document.querySelector('.oe_login_form');

                    if (loginForm) {
                        loginForm.addEventListener('submit', function(e) {
                            e.preventDefault();

                            grecaptcha.ready(function() {
                                grecaptcha.execute('6LdhdR4rAAAAAE8GMt_ToOGXsfqvUe2Mv4lXRpUX', {action: 'login'})
                                .then(function(token) {
                                    // Add token to form
                                    const input = document.createElement('input');
                                    input.type = 'hidden';
                                    input.name = 'recaptcha_response';
                                    input.value = token;
                                    loginForm.appendChild(input);

                                    // Submit form properly
                                    loginForm.submit();
                                })
                                .catch(function(error) {
                                    console.error('reCAPTCHA error:', error);
                                    alert('CAPTCHA verification failed. Please try again.');
                                });
                            });
                        });
                    }
                });
            </script>
        </xpath>
    </template>

    <!-- Signup Page -->
    <template id="signup" inherit_id="auth_signup.signup" name="Signup with reCAPTCHA">
        <xpath expr="//form" position="after">
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const signupForm = document.querySelector('.oe_signup_form');

                    if (signupForm) {
                        signupForm.addEventListener('submit', function(e) {
                            e.preventDefault();

                            grecaptcha.ready(function() {
                                grecaptcha.execute('6LdhdR4rAAAAAE8GMt_ToOGXsfqvUe2Mv4lXRpUX', {action: 'signup'})
                                .then(function(token) {
                                    // Add token to form
                                    const input = document.createElement('input');
                                    input.type = 'hidden';
                                    input.name = 'recaptcha_response';
                                    input.value = token;
                                    signupForm.appendChild(input);

                                    // Submit form
                                    signupForm.submit();
                                })
                                .catch(function(error) {
                                    console.error('reCAPTCHA error:', error);
                                    const errorDiv = document.getElementById('err') || document.createElement('div');
                                    errorDiv.id = 'err';
                                    errorDiv.style.color = 'red';
                                    errorDiv.textContent = 'CAPTCHA verification failed. Please try again.';
                                    signupForm.appendChild(errorDiv);
                                });
                            });
                        });
                    }
                });
            </script>
        </xpath>
    </template>
</odoo>